<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>摄像头拍照</title>
  <script src="http://html5media.googlecode.com/svn/trunk/src/html5media.min.js"></script>
</head>
<body>
  <video id="video" width="480" height="320" controls>
  </video>
  <div>
    <button id="capture">拍照</button>
  </div>
  <canvas id="canvas" width="480" height="320"></canvas>
  <script>
      

    function initSourceWebcam(){
        // init default value
        var onError = function(error){
            alert('Webcam Error\nName: '+error.name + '\nMessage: '+error.message);
        }

        var domElement = document.getElementById('video');
        domElement.setAttribute('autoplay', '');
        domElement.setAttribute('muted', '');
        domElement.setAttribute('playsinline', '');
        // domElement.style.width = document.documentElement.clientWidth + 'px';
        // domElement.style.height = document.documentElement.clientHeight + 'px';

        // check API is available
        if(navigator.mediaDevices === undefined || navigator.mediaDevices.enumerateDevices === undefined || navigator.mediaDevices.getUserMedia === undefined){
            if(navigator.mediaDevices === undefined){
                var fctName = 'navigator.mediaDevices';
            }
            else if(navigator.mediaDevices.enumerateDevices === undefined){
                var fctName = 'navigator.mediaDevices.enumerateDevices';
            }
            else if(navigator.mediaDevices.getUserMedia === undefined){
                var fctName = 'navigator.mediaDevices.getUserMedia';
            }
            else{
                console.assert(false);
            }
            onError({
                name: '',
                message: 'WebRTC issue-! '+fctName+' not present in your browser'
            });
            return null;
        }

        // get available devices
        navigator.mediaDevices.enumerateDevices().then(function(devices){

            var userMediaConstraints = {
                audio: false,
                video: {
                    facingMode: 'environment',
                }
            }

            // get a device which satisfy the constraints
            navigator.mediaDevices.getUserMedia(userMediaConstraints).then(function success(stream){
                domElement.srcObject = stream;
                document.body.addEventListener('click', function(){
                    domElement.play();
                });
                // wait until the video stream is ready
                // var interval = setInterval(function(){
                //     if(!domElement.videoWidth){
                //         return;
                //     }
                //     stage.appendChild(domElement);
                //     clearInterval(interval);
                // }, 1000/50);
            }).catch(function(error){
                onError({
                    name: error.name,
                    message: error.message
                });
            });
        }).catch(function(error){
            onError({
                message: error.message
            });
        });

        return domElement;
    }

    initSourceWebcam();
    //访问用户媒体设备的兼容方法
    // function getUserMedia(constraints, success, error) {
    // //   if (navigator.mediaDevices.getUserMedia) {
    //     //最新的标准API
    //     MediaDevices.getUserMedia(constraints, success, error);
    //     //navigator.getUserMedia(constraints, success, error);
    //     //navigator.mediaDevices.getUserMedia(constraints).then(success).catch(error);
    // //   } else if (navigator.webkitGetUserMedia) {
    // //     //webkit核心浏览器
    // //     navigator.webkitGetUserMedia(constraints,success, error)
    // //   } else if (navigator.mozGetUserMedia) {
    // //     //firfox浏览器
    // //     navigator.mozGetUserMedia(constraints, success, error);
    // //   } else if (navigator.getUserMedia) {
    // //     //旧版API
    // //     navigator.getUserMedia(constraints, success, error);
    // //   }
    // }

    // let video = document.getElementById('video');
    // let canvas = document.getElementById('canvas');
    // let context = canvas.getContext('2d');

    // function success(stream) {
    //   //兼容webkit核心浏览器
    //   let CompatibleURL = window.URL || window.webkitURL;
    //   //将视频流设置为video元素的源
    //   console.log(stream);

    //   //video.src = CompatibleURL.createObjectURL(stream);
    //   video.srcObject = stream;
    //   video.play();
    // }

    // function error(error) {
    //   console.log(`访问用户媒体设备失败${error.name}, ${error.message}`);
    // }

    // if (navigator.mediaDevices.getUserMedia || navigator.getUserMedia || navigator.webkitGetUserMedia || navigator.mozGetUserMedia) {
    //   //调用用户媒体设备, 访问摄像头
    //   getUserMedia({video : {width: 480, height: 320}}, success, error);
    // } else {
    //   alert('不支持访问用户媒体');
    // }

    // document.getElementById('capture').addEventListener('click', function () {
    //   context.drawImage(video, 0, 0, 480, 320);      
    // })
  </script>
</body>
</html>